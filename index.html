<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Turbulence Predictor </title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f7f8fb; color:#111; padding:24px; }
    .card { max-width:720px; margin:28px auto; background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(15,20,40,0.06); padding:20px; }
    h1 { margin:0 0 8px 0; font-size:20px; }
    p.lead { margin:0 0 18px 0; color:#555; font-size:14px; }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    label { display:block; font-size:13px; color:#333; margin-bottom:6px; }
    input[type="number"], input[type="text"] { width:100%; padding:8px 10px; border:1px solid #e0e4ee; border-radius:8px; font-size:14px; box-sizing:border-box; }
    .full { grid-column:1/-1; }
    button { background:#0b66ff; color:white; padding:10px 14px; border-radius:10px; border:none; font-weight:600; cursor:pointer; }
    .result { margin-top:16px; padding:12px; border-radius:8px; background:#f1f7ff; }
    .badge { font-weight:700; padding:6px 10px; border-radius:999px; display:inline-block; }
    .low { background:#e6f7ea; color:#1f7a3a; }
    .moderate { background:#fff7df; color:#a06a00; }
    .severe { background:#ffecec; color:#8b1c1c; }
    .small { font-size:13px; color:#555; margin-top:8px; }
    .error { color:#8b1c1c; margin-top:12px; font-weight:600; }
    footer { text-align:center; font-size:12px; color:#777; margin-top:18px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Turbulence Predictor</h1>
    <p class="lead">Enter atmospheric readings below and click <strong>Predict</strong>. This sends the data to the local prediction API (Flask) and displays severity + confidence.</p>

    <form id="predict-form">
      <div class="grid">
        <div>
          <label for="wind_speed_10m">Wind speed (10m) m/s</label>
          <input id="wind_speed_10m" name="wind_speed_10m" type="number" step="any" value="5.2" required>
        </div>

        <div>
          <label for="wind_speed_100m">Wind speed (100m) m/s</label>
          <input id="wind_speed_100m" name="wind_speed_100m" type="number" step="any" value="12.1" required>
        </div>

        <div>
          <label for="wind_shear">Wind shear (100m - 10m) m/s</label>
          <input id="wind_shear" name="wind_shear" type="number" step="any" value="6.9" required>
        </div>

        <div>
          <label for="relative_humidity_2m">Relative humidity (%)</label>
          <input id="relative_humidity_2m" name="relative_humidity_2m" type="number" step="any" value="72" required>
        </div>

        <div>
          <label for="cloud_cover">Cloud cover (%)</label>
          <input id="cloud_cover" name="cloud_cover" type="number" step="any" value="80" required>
        </div>

        <div>
          <label for="surface_pressure">Surface pressure (hPa)</label>
          <input id="surface_pressure" name="surface_pressure" type="number" step="any" value="995.2" required>
        </div>

        <div class="full">
          <label for="dewpt_dep">Dewpoint depression (°C) — <small>dewpt_dep</small></label>
          <input id="dewpt_dep" name="dewpt_dep" type="number" step="any" value="1.2" required>
        </div>

      </div>

      <div style="margin-top:14px; display:flex; gap:10px; align-items:center;">
        <button type="submit">Predict</button>
        <div id="spinner" style="display:none;color:#0b66ff;">⏳ predicting...</div>
      </div>
    </form>

    <div id="output" class="result" style="display:none;">
      <div id="pred-badge" class="badge"></div>
      <div id="pred-confidence" class="small"></div>
      <div id="pred-prob" class="small"></div>
    </div>

    <div id="err" class="error" style="display:none;"></div>

    <footer>Local demo — API: <code>http://127.0.0.1:8000/predict</code></footer>
  </div>

<script>
/*
  Updated client:
   - Sends feature vector expected by model: lat,lon,hour,dayofyear,TPI,lat_bin,lon_bin
   - Points to API at host:9090 (change back to 8000 if you run container on :8000)
   - Builds a simple demo TPI (proxy) from wind_shear * cloud_cover fraction.
   - Posts a JSON array [ record ] which matches your local API tests earlier.
*/
const API_URL = "http://127.0.0.1:9090/predict"; // <-- set to 9090 (or 8000 if you run container on 8000)

const form = document.getElementById('predict-form');
const out = document.getElementById('output');
const err = document.getElementById('err');
const spinner = document.getElementById('spinner');
const predBadge = document.getElementById('pred-badge');
const predConfidence = document.getElementById('pred-confidence');
const predProb = document.getElementById('pred-prob');

function safeNumber(v){
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : null;
}

// Small demo TPI proxy: uses wind_shear scaled by cloud cover fraction.
// Replace this with server-side TPI calculation when available.
function computeDemoTPI(wind_shear, cloud_cover){
  if (wind_shear === null) return null;
  const cc = (cloud_cover === null) ? 0.5 : Math.max(0, Math.min(1, cloud_cover/100));
  return wind_shear * (1 + 0.5*cc); // simple heuristic
}

form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  err.style.display = 'none';
  out.style.display = 'none';
  spinner.style.display = 'inline-block';

  try {
    // read inputs
    const lat = safeNumber(document.getElementById('lat').value);
    const lon = safeNumber(document.getElementById('lon').value);
    const wind_speed_10m = safeNumber(document.getElementById('wind_speed_10m').value);
    const wind_speed_100m = safeNumber(document.getElementById('wind_speed_100m').value);
    const wind_shear = safeNumber(document.getElementById('wind_shear').value);
    const relative_humidity_2m = safeNumber(document.getElementById('relative_humidity_2m').value);
    const cloud_cover = safeNumber(document.getElementById('cloud_cover').value);
    const surface_pressure = safeNumber(document.getElementById('surface_pressure').value);
    const dewpt_dep = safeNumber(document.getElementById('dewpt_dep').value);

    // basic validation
    if (lat === null || lon === null) throw new Error("Please provide numeric latitude and longitude.");

    // time features: use current local time (UTC could be used if desired)
    const now = new Date();
    const hour = now.getHours(); // 0-23
    const startOfYear = new Date(now.getFullYear(), 0, 0);
    const diff = now - startOfYear;
    const oneDay = 1000 * 60 * 60 * 24;
    const dayofyear = Math.floor(diff / oneDay);

    // compute TPI placeholder (temporary). Replace with server-side formula if you have it.
    const TPI = computeDemoTPI(wind_shear, cloud_cover);

    // lat/lon bins: simple integer truncate (matches training pipeline's lat_bin/lon_bin)
    const lat_bin = Math.trunc(lat);
    const lon_bin = Math.trunc(lon);

    // build record in the order/fields expected by your model pipeline
    const record = {
      lat: lat,
      lon: lon,
      hour: hour,
      dayofyear: dayofyear,
      TPI: TPI === null ? 0.0 : TPI,
      lat_bin: lat_bin,
      lon_bin: lon_bin
    };

    // POST JSON array (the service earlier accepted array of records)
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify([ record ])
    });

    if (!resp.ok) {
      const text = await resp.text();
      throw new Error(`API error: ${resp.status} — ${text}`);
    }

    const j = await resp.json();

    // your API returns: { n_rows, results } or earlier tests showed: { results: [...] } OR { predictions, confidence }
    // handle common variants robustly:
    let predText = null;
    let confVal = null;

    // 1) If API returns the 'results' array with objects like {pred_text, probs}
    if (Array.isArray(j.results) && j.results.length > 0 && j.results[0].pred_text !== undefined) {
      predText = j.results[0].pred_text;
      if (Array.isArray(j.results[0].probs)) confVal = j.results[0].probs[0] ?? null;
    }
    // 2) If API returns predictions/confidence directly as arrays
    else if (Array.isArray(j.predictions) && j.predictions.length > 0) {
      predText = j.predictions[0];
      confVal = Array.isArray(j.confidence) ? j.confidence[0] : j.confidence;
    }
    // 3) If API returns simpler form
    else if (j.pred && j.confidence) {
      predText = j.pred;
      confVal = j.confidence;
    }
    // 4) fallback: see if 'n_rows' + 'results' exists
    else if (j.n_rows && Array.isArray(j.results) && j.results.length>0) {
      const r = j.results[0];
      predText = r.pred_text || r.pred || (r.pred_label === 0 ? "Low" : (r.pred_label===1 ? "Moderate" : "Severe"));
      confVal = (r.probs && r.probs[0]) || r.confidence || null;
    }

    if (!predText) {
      // if nothing matched, just show the raw response
      predText = JSON.stringify(j).slice(0,200);
      confVal = null;
    }

    predBadge.textContent = predText;
    predBadge.className = 'badge ' + (predText.toLowerCase() === 'severe' ? 'severe' : (predText.toLowerCase() === 'moderate' ? 'moderate' : 'low'));
    predConfidence.textContent = confVal !== null ? `Confidence: ${(confVal*100).toFixed(1)}%` : '';
    predProb.textContent = confVal !== null ? `Raw score: ${confVal.toFixed(3)}` : '';

    out.style.display = 'block';
  } catch (e) {
    err.textContent = e.message || String(e);
    err.style.display = 'block';
  } finally {
    spinner.style.display = 'none';
  }
});
</script>
</body>
</html>